#!/usr/bin/env ruby

require 'bundler/setup'
require 'fluent/icons'

require 'pry'
require 'git'
require 'fileutils'
require 'progress_bar'

# if Dir.exists?('fluentui-system-icons')
#   puts "Theres's already a copy of 'microsoft/fluentui-system-icons'. You should probably remove that first! Skipping.."
# else
#   puts "Cloning the 'microsoft/fluentui-system-icons' repository. This might take a while.."
#   Git.clone('https://github.com/microsoft/fluentui-system-icons.git', 'fluentui-system-icons')
# end

# puts 'Transferring the SVG Icons'
# icons = Dir['fluentui-system-icons/assets/*/SVG/*']
# progress_bar = ProgressBar.new(icons.size)

# icons.each do |icon|
#   FileUtils.copy(icon, 'lib/app/assets/fonts/fluent')
#   progress_bar.increment!
# end

puts 'Generating a new Preview file'

@icons = {}

Dir['lib/app/assets/fonts/fluent/*.svg'].map { |icon| icon.split('/').last.split('.').first }.group_by { |icon| icon.split('_')[2..][-0..-3].join('_') }.each do |group, icons|
  @icons[group] = {
    icons: {
      filled:  [],
      regular: [],
    }
  }

  icons.group_by { |icon| icon.split('_').last }.each do |variation, icons|
    icons.each do |icon|
      @icons[group][:icons][variation.to_sym] << {
        name: icon.split('_')[2..-3].join('_'),
        weight: icon.split('_')[-2],
        src: ['..', '..', 'lib/app/assets/fonts/fluent', "#{ icon }.svg"].join('/')
      }
    end
  end
end

template = File.read('lib/public/fluent-ui-icons.template.html.erb')
result   = ERB.new(template).result(binding)

File.open('lib/public/fluent-ui-icons.html', 'w+') do |f|
  f.write(result)
end

# puts 'Cleaning up'
# FileUtils.rm_rf('fluentui-system-icons') if Dir.exists?('fluentui-system-icons')